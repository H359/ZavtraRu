<%!
from pytils import numeral, dt
from zavtra.comments.template_tags import get_comments_for
%>\
<%def name="news_block(items)">\
<h3>Новости</h3>
<ul class="unstyled">
% for item in items:
<% url = item.get_absolute_url() %>\
<li>
    <h5><a href="${ url }">${ item.title }</a></h5>
    <small>${ self.ru_date(item.pub_date) }</small>
    <div data-clickable="${ url }" class="article-text">${ item.description }</div>
</li>
% endfor
</%def>\
<%def name="comment(item)">\
<% author = item.get_author() %>
<li id="comment-${ item.id }" style="padding-left: ${ item.depth_truncated()*40 }px">
    <div class="comment">
	<div class="avatar">
	    <a href="#" rel="popover" data-content="Пользователь ${ author } с нами с ${ ru_date(item.author.date_joined,inflected=True,format=u'%d %B %Y') }" title="${ author }"><img src="${ item.author.avatar() }" width="32" /></a>
	</div>
	<div class="inner">
	    <div class="body ym-clearfix">
		<div class="author"><a href="${ item.author.get_absolute_url() }">${ item.author }</a>, <time datetime="${ item.created_at }">${ ru_date(item.created_at) }<time></div>
		<div class="text">
		% if item.enabled:
		${ item.comment | h }
		% else:
		<em>комментарий скрыт</em>
		    % if request.user.is_authenticated() and request.user.is_staff:
		    <br/>Текст:<br/>${ item.comment | h }
		    % endif
		% endif
		</div>
		<div class="actions">
		    % if request.user.is_authenticated() and request.user.is_active:
			% if item.enabled:
			<a href="#reply:${ item.id }" class="btn small primary">Ответить</a>
			% endif
			% if request.user.is_staff:
			<%doc>and perms.comments.moderate</%doc>
			    % if item.enabled:
			    <a href="#hide:${ item.id }}" class="btn small danger">Скрыть</a>
			    % else:
			    <a href="#hide:${ item.id }}" class="btn small danger">Раскрыть</a>
			    % endif 
			% endif
		    % endif
		</div>
	    </div>
	</div>
    </div>
</li>
</%def>\
<%def name="comments_for(item)">\
<% comments = get_comments_for(item) %>
<div class="comments">
    <h3>Комментарии</h3>
    <div class="content"><ul id="comments" class="unstyled">
	% for comment_item in comments['comments']:
	${ comment(comment_item) }
	% endfor
    </ul></div>
    % if request.user.is_authenticated():
    <div class="comment-form comment ym-clearfix">
	<div class="alert-message error hide">Похоже, вы что-то неправильно заполнили. Ниже вы найдёте дополнительную информацию.</div>
	<div class="avatar"><img src="${ request.user.avatar() }" width="32" /></div>
	<form class="inner" method="post" action="/comments/add/">
	    <fieldset class="body">
		<h4>Ваш комментарий:</h4>
		<div><input type="hidden" name="csrfmiddlewaretoken" value="${ csrf_token }" /></div>
		% for field in comments['form']:
		% if field.is_hidden:
		<div>${ field }</div>
		% else:
		<div class="ym-clearfix">
		    ${ field.label_tag() }
		    <div class="input">
			${ field }
			% if field.help_text:
			<span class="help-block">${ field.help_text }</span>
			% endif
		    </div>
		</div>
		% endif
		% endfor
		<div class="actions"><input type="submit" class="btn primary"  value="Отправить" /></div>
	    </fieldset>
	</form>
    </div>
    <script>window.comments_bootstrap=function(){$('#comments').comments();}</script>
    % else:
    <div class="comment"><div class="alert-message info">
	<p>Чтобы иметь возможность оставлять комментарии, вам нужно <a href="/login/">войти в свою учетную запись</a> (на сайте существует возможность зайти под учетной записи Twitter, Facebook и Живого Журнала) или <a href="/accounts/register/">зарегистрировать её</a>, если у вас таковой еще нет.</p>
    </div></div>
    % endif
</div>
</%def>\
<%def name="ru_date(date, inflected=False, format=u'%d.%m.%Y')">${ dt.ru_strftime(date=date, inflected=inflected, format=format) }</%def>\
<%def name="comments_count(num)">${ numeral.get_plural(num, (u'комментарий', u'комментария', u'комментариев'), u'нет комментариев') }</%def>\
<!DOCTYPE html>
<html lang="ru">
    <head>
	<meta charset="utf-8" />\
	<title><%block name="page_title">Газета &laquo;Завтра&raquo;</%block></title>
	<meta name="keywords" content="<%block name="meta_keywords">Россия,русский народ,проханов,свежий номер</%block>" />
	<meta name="description" content="<%block name="meta_description">Сетевое представительство газеты Завтра</%block>" />
	<meta name="author" content="<%block name="meta_author">Редакция газеты Завтра</%block>" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
	<meta name="yandex-verification" content="79bffe9a083206fe" />\
	<%block name="meta_extra"></%block>\
	<link rel="stylesheet" type="text/css" href="${ STATIC_URL }css/2.0/style.css" />
	<link rel="alternate" type="application/rss+xml" title="Газета Завтра" href="http://zavtra.ru[% url corecontent.rss.latest %]" />
	<link rel="shortcut icon" href="${ STATIC_URL }img/zav_icon.gif" />
	<link rel="stylesheet" type="text/css" href="${ STATIC_URL }css/2.0/iehacks.css" />
	<script>var _gaq = _gaq || [];_gaq.push(['_setAccount', 'UA-27628875-1']);_gaq.push(['_trackPageview']);(function() {var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);})();</script>
    </head>
    <body>
	<!-- tns-counter.ru -->
	<script type="text/javascript">var img = new Image();img.src = 'http://www.tns-counter.ru/V13a***R>' + document.referrer.replace(/\*/g,'%2a') + '*zavtra_ru/ru/UTF-8/tmsec=zavtra_total/' + Math.round(Math.random() * 1000000000);</script>
	<noscript><img src="http://www.tns-counter.ru/V13a****zavtra_ru/ru/UTF-8/tmsec=zavtra_total/" width="1" height="1" alt=""></noscript>
	<!--/ tns-counter.ru -->
	<div>
	    <div class="ym-hlist topbar">
		<ul>
		    <li><a href="/#gazette">Газета</a></li>
		    <li><a href="/content/rubric/voprosyi-prohanovu/">Вопросы Проханову</a></li>
		    <li>
			<form action="/search/" method="get">
			    <input class="nav-search" type="search" name="q" placeholder="Поиск..." />
			    <input class="btn" type="submit" value="Искать" />
			</form>
		    </li>
		</ul>
		<div class="userbar">
		    % if request.user.is_authenticated():
		    Здравствуйте, ${ request.user.get_full_name() }. <a class="btn small" href="/logout/">Выйти</a>
		    % else:
		    <a class="btn" href="/login/">Войти</a>
		    % endif
		</div>
	    </div>
	</div>
	<div id="main"><div class="ym-wrapper">
	    <div class="ym-wbox">
		<div class="ym-grid">
		    <div class="ym-gbox ym-clearfix">
			<div id="logo"><a href="/"><img src="${ STATIC_URL }img/logo.gif" /></a></div>
			% if quote is not None:
			<blockquote id="main-cite">&laquo;<a href="${ quote.source.get_absolute_url() }">${ quote.quote }</a>&raquo;</blockquote>
			% endif
		    </div>
		    <div class="ym-g75 ym-gl">
			<div class="ym-gbox ym-clearfix">
			    <div class="ym-hlist rubrics-list ym-clearfix"><ul>
				% for item in filter(lambda w: w.on_top, rubrics):
				<li><a href="${ item.get_absolute_url() }">${ item.title }</a></li>
				% endfor
			    </ul></div>
			    <div class="ym-hlist featured-list"><ul>
				% for item in featured:
				<li><a href="${ item.get_absolute_url() }">${ item.title }</a></li>
				% endfor
			    </ul></div>
			    <div class="red-stripe">
				<h3>Красная строка</h3>
				<div class="scrollee">
				    <ul class="unstyled scrollable ym-clearfix">
				    % for num,item in enumerate(current_items):
				    <li${ " class='first'" if num == 0 else "" }>
					<% url = item.get_absolute_url() %>\
					<h4><a href="${ url }">${ item.title }</a></h4>
					<div class="article-text" data-clickable="${ url }">${ item.description }</div>
				    </li>
				    % endfor
				    </ul>
				</div>
			    </div>
			</div>
		    </div>
		    <div class="ym-g25 ym-gr">
			<div class="ym-gbox ym-clearfix adv rubrics">
			    <h3>Реклама</h3>
			    <div class="bnrok" id="DIV_DA_49094"></div><% banners_pool.append(49094) %>\
			</div>
		    </div>
		</div>
		<div class="ym-grid">
		    <div class="ym-g62 ym-gl"><div class="ym-gbox ym-clearfix"><%block name="main_column"></%block></div></div>
		    <div class="ym-g38 ym-gr"><div class="ym-gbox ym-clearfix rubrics"><%block name="side_column"><%include file="minipoll/latest_poll.html" /></%block></div></div>
		    <div class="ym-gbox ym-gr rubrics">
			<h3>Реклама</h3>
			<div class="bnrok" id="DIV_DA_50417"></div><% banners_pool.append(50417) %>\
		    </div>
		    <div class="ym-g50 ym-gl"><div class="ym-gbox ym-clearfix">
			<address>
			    <strong>Адрес редакции:</strong><br/>
			    119146, Москва, Фрунзенская наб., 18–60<br/>
			    Электронная почта: <a href="mailto:zavtra@zavtra.ru">zavtra@zavtra.ru</a><br/>
			    Телефон: (495) 726-54-83
			</address>
		    </dIv></div>
		    <div class="ym-g50 ym-gr"><div class="ym-gbox ym-clearfix">
			<a href="http://zavtra.ru/content/rubric/tehnicheskij-blog/">Технический блог</a><br/>
			Электронная почта технического отдела <a href="mailto:web@zavtra.ru">web@zavtra.ru</a>.
		    </div></div>
		</div>
	    </div>
	</div></div>
	<script src="${ STATIC_URL }js/jquery.1.7.min.js"></script>
	<script src="${ STATIC_URL }js/jquery.cookie.js"></script>
	<script src="${ STATIC_URL }js/comments.js"></script>
	<script src="${ STATIC_URL }js/core.js"></script>
	% for i in banners_pool:
	<script charset="windows-1251" type="text/javascript" src="http://www.directadvert.ru/show.cgi?adp=${ i }&div=DIV_DA_${ i }"></script>\
	% endfor
    </body>
</html>